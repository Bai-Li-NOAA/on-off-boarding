name: Test Onboarding and Offboarding Workflows

on:
  # Trigger on changes to workflow files
  push:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  # Monthly scheduled run (1st of each month at 00:00 UTC)
  schedule:
    - cron: '0 0 1 * *'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  test-workflows:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Select random reviewer
        id: select-reviewer
        run: |
          reviewers=("Bai-Li-NOAA")
          selected_reviewer=${reviewers[$RANDOM % ${#reviewers[@]}]}
          echo "reviewer=${selected_reviewer}" >> $GITHUB_OUTPUT
          echo "Selected reviewer: ${selected_reviewer}"
      
      - name: Create test issue from template
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const reviewer = '${{ steps.select-reviewer.outputs.reviewer }}';
            
            // --- CONFIGURATION ---
            // Update this to match your actual template filename
            const templatePath = '.github/ISSUE_TEMPLATE/add_new_profile.md';
            
            // Define rules for filling out data based on Header keywords
            // The script looks for headers (###) containing these words
            const dataRules = {
              'name': 'Test User (Automated)',
              'email': 'test.user@email.com',
              'username': 'test-user-automated',
              'onboarding': new Date().toISOString().split('T')[0], // Today
              'offboarding': new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +90 days
              'title': 'Research Fish BIologist',
              'affiliation': 'Automated Testing Program',
              'bio': 'This is an automated test profile created to validate workflows.',
              'default': 'Automated test response.' // Fallback for unknown headers
            };
            // ---------------------

            try {
              // 1. Read the template file
              if (!fs.existsSync(templatePath)) {
                throw new Error(`Template file not found at ${templatePath}`);
              }
              let content = fs.readFileSync(templatePath, 'utf8');

              // 2. Remove YAML Frontmatter (the metadata at the top between --- and ---)
              content = content.replace(/^---\n[\s\S]*?\n---\n/, '');

              // Define the "Red Flag" Warning
              const redFlag = `> [!CAUTION]
              > **AUTOMATED TEST RUN**
              >
              > **Reviewer (@${reviewer}):** Please review the profile and checklist below to ensure they display correctly. 
              >
              > This issue was created automatically to test the onboarding/offboarding workflows.`;

              // 3. Process the content to fill in blanks
              // We split by "### " to find sections
              const sections = content.split(/\n### /);
              
              // Rebuild the body
              let newBody = sections[0]; // The part before the first header (usually empty or welcome text)
              
              for (let i = 1; i < sections.length; i++) {
                const lines = sections[i].split('\n');
                const headerTitle = lines[0].trim(); // The text immediately after ###
                
                // Determine what data to put here based on the header title
                let fillValue = dataRules['default'];
                const lowerTitle = headerTitle.toLowerCase();
                
                for (const [key, value] of Object.entries(dataRules)) {
                  if (lowerTitle.includes(key)) {
                    fillValue = value;
                    break;
                  }
                }
                
                // Reconstruct the section:
                // Header + Original content (instructions) + Our Answer
                // We add two newlines to ensure separation
                newBody += `\n### ${headerTitle}\n\n${lines.slice(1).join('\n')}\n\n**${fillValue}**`;
              }
              
              // 4. Create the issue
              let issue;
              const issueTitle = '[Test Profile]: Test User (Automated Test)';
              const labels = ['automated-test'];

              try {
                issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: newBody,
                  labels: labels,
                  assignees: [reviewer]
                });
              } catch (assignError) {
                console.log(`Warning: Could not assign reviewer: ${assignError.message}`);
                issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: newBody,
                  labels: labels
                });
              }
              
              console.log(`Created test issue #${issue.data.number} using template.`);
              return issue.data.number;

            } catch (error) {
              core.setFailed(`Failed to create issue from template: ${error.message}`);
            }
      
      - name: Get onboard workflows
        id: get-onboard-workflows
        run: |
          cd .github/workflows
          onboard_workflows=$(ls onboard-*.yml onboard-*.yaml 2>/dev/null | sed 's/onboard-//' | sed 's/\.yml$//' | sed 's/\.yaml$//' | tr '\n' ' ' || echo "")
          echo "workflows=${onboard_workflows}" >> $GITHUB_OUTPUT
          echo "Onboard workflows: ${onboard_workflows}"
      
      - name: Get offboard workflows
        id: get-offboard-workflows
        run: |
          cd .github/workflows
          offboard_workflows=$(ls offboard-*.yml offboard-*.yaml 2>/dev/null | sed 's/offboard-//' | sed 's/\.yml$//' | sed 's/\.yaml$//' | tr '\n' ' ' || echo "")
          echo "workflows=${offboard_workflows}" >> $GITHUB_OUTPUT
          echo "Offboard workflows: ${offboard_workflows}"
      
      - name: Test onboarding workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTION_DISPATCH_PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const workflows = '${{ steps.get-onboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            
            console.log(`Testing ${workflows.length} onboarding workflows on issue #${issueNumber}`);
            
            for (const workflow of workflows) {
              const command = `/onboard-${workflow}`;
              console.log(`Posting command: ${command}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: command
              });
              
              // Wait 5 seconds between commands to ensure reliable triggering
              await new Promise(resolve => setTimeout(resolve, 5000));
            }
      
      - name: Wait between onboard and offboard workflows
        run: |
          echo "Waiting 10 seconds before starting offboard workflows..."
          sleep 10
      
      - name: Test offboarding workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTION_DISPATCH_PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const workflows = '${{ steps.get-offboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            
            console.log(`Testing ${workflows.length} offboarding workflows on issue #${issueNumber}`);
            
            for (const workflow of workflows) {
              const command = `/offboard-${workflow}`;
              console.log(`Posting command: ${command}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: command
              });
              
              // Wait 5 seconds between commands to ensure reliable triggering
              await new Promise(resolve => setTimeout(resolve, 5000));
            }
      
      - name: Add test completion comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTION_DISPATCH_PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const onboardWorkflows = '${{ steps.get-onboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            const offboardWorkflows = '${{ steps.get-offboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            
            const workflowList = [
              '**Onboarding workflows tested** (' + onboardWorkflows.length + '):',
              ...onboardWorkflows.map(w => `- /onboard-${w}`),
              '',
              '**Offboarding workflows tested** (' + offboardWorkflows.length + '):',
              ...offboardWorkflows.map(w => `- /offboard-${w}`)
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `:white_check_mark: **Automated workflow testing completed**\n\nAll onboarding and offboarding workflow commands have been posted to this issue. Please verify that the workflows executed correctly by checking the comments above.\n\n${workflowList}\n\n**Workflow run:** ${runUrl}\n\n**Note:** This test issue can be closed after verification.`
            });
            
            console.log(`Test completed for issue #${issueNumber}`);
